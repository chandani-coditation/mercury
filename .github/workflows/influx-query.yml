name: influx-query

on:
  workflow_dispatch:
    inputs:
      ticket_id:
        description: "Ticket ID"
        required: true
        type: string
      ticket_created_date:
        description: "Ticket creation date (ISO 8601 format)"
        required: true
        type: string
      window_minutes:
        description: "Time window before ticket creation"
        required: false
        default: "15"

permissions:
  contents: read

jobs:
  influx-query:
    runs-on: self-hosted
    timeout-minutes: 10

    environment: np

    env:
      INFLUX_URL: ${{ vars.INFLUX_URL }}
      ORG: ${{ vars.ORG }}
      BUCKET: ${{ vars.BUCKET }}
      INFLUX_TOKEN: ${{ secrets.INFLUX_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch logs for ticket
        shell: bash
        run: |
          set -e
          chmod +x scripts/influx-query.sh
          scripts/influx-query.sh \
            '${{ inputs.ticket_id }}' \
            '${{ inputs.ticket_created_date }}' \
            '${{ inputs.window_minutes }}'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: influx-${{ inputs.ticket_id }}
          path: outputs/influx-${{ inputs.ticket_id }}.csv
          retention-days: 1

      - name: Cleanup outputs directory
        if: always()
        shell: bash
        run: |
          rm -rf outputs
