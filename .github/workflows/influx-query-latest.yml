---
name: influx-query

on:
  workflow_dispatch:
  repository_dispatch:
    types: [influx-query]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  influx-query:
    strategy:
      fail-fast: false
      matrix:
        include:
          - env_name: np
          - env_name: pr

    runs-on: self-hosted
    environment: ${{ matrix.env_name }}
    timeout-minutes: 10

    env:
      INFLUX_URL: ${{ vars.INFLUX_URL }}
      ORG: ${{ vars.ORG }}
      BUCKET: ${{ vars.BUCKET }}
      INFLUX_TOKEN: ${{ secrets.INFLUX_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run InfluxDB queries for tickets
        shell: bash
        run: |
          set -e
          chmod +x scripts/influx-query.sh
          # Get parameters from repository_dispatch payload or environment variables
          TICKET_ID="${{ github.event.client_payload.ticket_id || env.TICKET_ID }}"
          TICKET_DATE="${{ github.event.client_payload.ticket_created_date || env.TICKET_CREATED_DATE }}"
          WINDOW="${{ github.event.client_payload.window_minutes || env.WINDOW_MINUTES || '15' }}"
          # Validate inputs
          if [[ -z "$TICKET_ID" ]]; then
            echo "Error: ticket_id is required (set via repository_dispatch or TICKET_ID env var)"
            exit 1
          fi
          if [[ -z "$TICKET_DATE" ]]; then
            echo "Error: ticket_created_date is required (set via repository_dispatch or TICKET_CREATED_DATE env var)"
            exit 1
          fi
          if [[ ! "$TICKET_ID" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "Error: Invalid ticket_id format"
            exit 1
          fi
          if [[ ! "$TICKET_DATE" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2} ]]; then
            echo "Error: Invalid date format (expected ISO 8601)"
            exit 1
          fi
          if [[ ! "$WINDOW" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid window_minutes (must be numeric)"
            exit 1
          fi
          scripts/influx-query.sh "$TICKET_ID" "$TICKET_DATE" "$WINDOW"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: influx-query-${{ matrix.env_name }}
          path: outputs/*.csv
          if-no-files-found: error
          retention-days: 1

      - name: Cleanup generated files
        if: always()
        run: |
          echo "Cleaning up the generated files..."
          rm -rf outputs
